<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Heap fragmentation or how my micro-benchmark went wrong</title>
  <meta name="description" content="Writing a micro-benchmark is very simple — knowing what you measure and if the way your benchmarked code is called is the same as in your production environment is much more challenging." />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  
  <meta property="og:site_name" content="Thoughts from a Wall Street developer" />
  <meta property="og:title" content="Heap fragmentation or how my micro-benchmark went wrong"/>
  
  <meta property="og:description" content="Writing a micro-benchmark is very simple — knowing what you measure and if the way your benchmarked code is called is the same as in your production environment is much more challenging." />
  
  <meta property="og:image" content="http://david-grs.github.io" />
  <meta property="og:url" content="http://david-grs.github.io/heap_fragmentation_micro_benchmark" >
  <meta property="og:type" content="blog" />
  <meta property="article:published_time" content="2016-12-08T22:46:00+01:00">

  <link rel="canonical" href="http://david-grs.github.io/heap_fragmentation_micro_benchmark"/>
  <link rel="shortcut icon" href="/assets/images/favicon.png" type="image/png"/>
  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />

  <link rel="apple-touch-icon" sizes="57x57" href="/assets/favicon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/favicon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/favicon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/favicon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/favicon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/favicon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/favicon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/favicon/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/assets/favicon/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/assets/favicon/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/assets/favicon/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/assets/favicon/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/assets/favicon/manifest.json">
  <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#00aba9">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff"> 
  
</head>

  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->

<a href="http://david-grs.github.io" class="logo-readium"><span class="logo" style="background-image: url()"></span></a>

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">Heap fragmentation or how my micro-benchmark went wrong</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person">David Gross</h4>
              on
              <time datetime="2016-12-08T22:46:00+01:00">08 Dec 2016</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>Writing a micro-benchmark is very simple — knowing what you measure and if the way your benchmarked code is called is the same as in your production environment is much more challenging.</p>

<p>There were a few things I knew about micro-benchmarking: you have to be careful that the compiler does not optimize out the code
you are timing, the results are inaccurate because all your caches are hot and you will get the maximum cache hit rate possible, 
you have to generate a “production-like” set of inputs in order to get something realistic, etc. It is really hard. </p>

<p>It is fine though, because we are aware of the dangers and the inaccuracy of the results. What usually matter are relative numbers, not absolute, and we 
accept to sacrifice a slight portion of accuracy to get some numbers and talk about something during lunch with your workmates. Everybody likes numbers, so 
let’s micro-benchmark.</p>

<h2 id="the-simplest-micro-benchmark">The simplest #µ-benchmark</h2>
<p>This is a very simple — and most boring I could find — micro-benchmark:</p>
<noscript><pre>void benchmark_unordered_map_emplace()
{
    static const int Iterations = 1e6;
    std::unordered_map&lt;int, int&gt; um;
    
    auto start = std::chrono::system_clock::now();
    for (int i = 0; i &lt; Iterations; ++i)
        um.emplace(i, i);
    auto end = std::chrono::system_clock::now();
    
    std::cout &lt;&lt; Iterations &lt;&lt; &quot; iterations of umap&lt;int, int&gt;::emplace() took &quot; &lt;&lt; std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(end - start).count() &lt;&lt; &quot;ms&quot; &lt;&lt; std::endl;
}</pre></noscript>
<script src="https://gist.github.com/david-grs/38b359aa9f20d7d27444c16c9e411855.js?file=awesome_benchmark.cc"> </script>

<p><br />
This gives us the output: <code>100000 iterations of umap&lt;int, int&gt;::emplace() took 565ms</code>. Awesome. This is exactly what we wanted to know.</p>

<p>Now, a few hours later, we added a lot of other small functions like this one. We are now measuring the time of the <em>emplace</em> operation for different containers,
with different contained type — to change their size and the cost of the move, copy, construction and destruction operations — and with different
number of elements in the container. We even added a layer of template because it looks better.</p>

<p>Our <em>main()</em> is now something like this:</p>
<noscript><pre>int main()
{
    benchmark_emplace&lt;std::unordered_map&lt;int, int&gt;&gt;();
    benchmark_emplace&lt;std::map&lt;int, int&gt;&gt;();
    benchmark_emplace&lt;boost::container::flat_map&lt;int, int&gt;&gt;();
  
    // Foo is a medium size object...
    benchmark_emplace&lt;std::unordered_map&lt;Foo, Foo&gt;&gt;();
    benchmark_emplace&lt;std::map&lt;Foo, Foo&gt;&gt;();
    benchmark_emplace&lt;boost::container::flat_map&lt;Foo, Foo&gt;&gt;();
  
    // We also test big objects, different number of elements, and a lot of other fun stuff. 
}</pre></noscript>
<script src="https://gist.github.com/david-grs/38b359aa9f20d7d27444c16c9e411855.js?file=even_more_awesome_benchmark.cc"> </script>

<p><br /></p>

<h2 id="the-tragedy">The tragedy</h2>
<p><em>At some point</em>, you decide to re-order the function calls. You don’t know why — just for convenience, because it is nicer like that, probably. And boom. You didn’t 
expect <em>anything</em> to change because you were staring these numbers for hours… but you now get: </p>

<p><code>100000 iterations of umap&lt;int, int&gt;::emplace() took 1143ms</code></p>

<p>How come? You run again and get the same results. Nothing changed. You checkout the previous commit and test again: it is fixed. How can a simple re-ordering of function
calls change by more than a factor two the time of this <em>for</em> statement?</p>

<h2 id="heap-fragmentation">Heap fragmentation</h2>
<p>The cause for this difference of time is simply the heap. I maintain a simple <a href="https://github.com/david-grs/mtrace">C++ wrapper around the malloc hooks</a> that gives to us the immediat
answer here:</p>

<p><code>
benchmark_unordered_map_emplace() took 565ms
time spent in malloc(): 231ms
time spent in free(): 1ms
time spent in realloc(): 0ms
benchmark_unordered_map_emplace() took 1097ms
time spent in malloc(): 916ms
time spent in free(): 94ms
time spent in realloc(): 0ms
</code></p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4>David Gross</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">Published <time datetime="2016-12-08 22:46">08 Dec 2016</time></p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span>Supported by</span></h5>
            <footer class="site-footer">
              <section class="poweredby">Proudly published with <a href="http://jekyllrb.com"> Jekyll</a></section>
              <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> You should subscribe to my feed.</span></a>
              <div class="inner">
                <section class="copyright">All content copyright <a href="/">David Gross</a> &copy; 2016<br>All rights reserved.</section>
              </div>
            </footer>
          </div>
        </div>
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'david-grs'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        
      </article>
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/cover.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Thoughts from a Wall Street developer</h1>
        <h2 class="blog-description">A blog about C++, with an emphasis on low-latency, performance measurements and system programming.
</h2>
        <a href="/" class="btn">Back to Overview</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>


    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75603420-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>
</html>
